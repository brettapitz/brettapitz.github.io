<!DOCTYPE html>
<html><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/brettapitz.github.io"
      },
      "articleSection" : "posts",
      "name" : "Translating GAS to NASM, part 4",
      "headline" : "Translating GAS to NASM, part 4",
      "description" : "Re-writing the code from chapter 6 of Programming from the Ground Up in NASM",
      "inLanguage" : "en-US",
      "author" : "Brett Apitz",
      "creator" : "Brett Apitz",
      "publisher": "Brett Apitz",
      "accountablePerson" : "Brett Apitz",
      "copyrightHolder" : "Brett Apitz",
      "copyrightYear" : "2021",
      "datePublished": "2021-03-29 12:33:46 -0500 -0500",
      "dateModified" : "2021-03-29 12:33:46 -0500 -0500",
      "url" : "https:\/\/brettapitz.github.io\/posts\/groundup4\/",
      "wordCount" : "998",
      "keywords" : [ "assembly","comp-sci","Blog" ]
  }
  </script>
<title> Translating GAS to NASM, part 4 </title>
<meta name="description" content="Personal site of Brett Apitz"/>
<meta name="author" content="Brett Apitz"/>

<link rel="stylesheet" type="text/css" href="https://brettapitz.github.io/main.min.css">
<body>
        <div id="wrapper">
<header>
    <h1 id="header-title"> Brett Apitz is Learning Stuff </h1>
    <div id="navbar">
        
        
        <a class="nav-link " href="https://brettapitz.github.io/">
            <svg class="icon" width="24" height="24" viewBox="0 0 16 16"><path d="M16 9.5l-3-3v-4.5h-2v2.5l-3-3-8 8v0.5h2v5h5v-3h2v3h5v-5h2z"></path></svg>
            <span class="text">Home</span>
        </a>
        
        
        <a class="nav-link " href="https://brettapitz.github.io/posts/">
            <svg class="icon" width="24" height="24" viewBox="0 0 16 16"><path d="M14 4v-2h-14v11c0 0.552 0.448 1 1 1h13.5c0.828 0 1.5-0.672 1.5-1.5v-8.5h-2zM13 13h-12v-10h12v10zM2 5h10v1h-10zM8 7h4v1h-4zM8 9h4v1h-4zM8 11h3v1h-3zM2 7h5v5h-5z"></path></svg>
            <span class="text">Posts</span>
        </a>
        
        
        <a class="nav-link " href="https://brettapitz.github.io/tags/">
            <svg class="icon" width="24" height="24" viewBox="0 0 16 16"><path d="M15.25 0h-6c-0.412 0-0.989 0.239-1.28 0.53l-7.439 7.439c-0.292 0.292-0.292 0.769 0 1.061l6.439 6.439c0.292 0.292 0.769 0.292 1.061 0l7.439-7.439c0.292-0.292 0.53-0.868 0.53-1.28v-6c0-0.412-0.338-0.75-0.75-0.75zM11.5 6c-0.828 0-1.5-0.672-1.5-1.5s0.672-1.5 1.5-1.5 1.5 0.672 1.5 1.5-0.672 1.5-1.5 1.5z"></path></svg>
            <span class="text">Tags</span>
        </a>
        
        
        <a class="nav-link " href="https://brettapitz.github.io/contact/">
            <svg class="icon" width="24" height="24" viewBox="0 0 16 16"><path d="M14.5 2h-13c-0.825 0-1.5 0.675-1.5 1.5v10c0 0.825 0.675 1.5 1.5 1.5h13c0.825 0 1.5-0.675 1.5-1.5v-10c0-0.825-0.675-1.5-1.5-1.5zM6.23 8.6l-4.23 3.295v-7.838l4.23 4.543zM2.756 4h10.488l-5.244 3.938-5.244-3.938zM6.395 8.777l1.605 1.723 1.605-1.723 3.29 4.223h-9.79l3.29-4.223zM9.77 8.6l4.23-4.543v7.838l-4.23-3.295z"></path></svg>
            <span class="text">Contact</span>
        </a>
        
    </div>
</header>
<div id="content" class="fadePageIn">

<div class="post">
  <div class="above-post">
  </div>
  <div class="post-content">
    <div class="post-headline">
      <h1 class="post-title">Translating GAS to NASM, part 4</h1>
      <h1 class="post-date">March 29, 2021</h1>
    </div>
    <p>This chapter was a <em>project</em>. Not only was there far more code than any previous chapter, but I also put off learning <code>make</code> until I was nearly finished, so I spent a whooooole lot of time re-assembling and re-linking. For anyone similarly ignorant of the wonders of makefiles, you can grab mine <a href="https://github.com/brettapitz/randomcode/blob/main/makefile">here</a> (or learn about them <a href="https://www.gnu.org/software/make/manual/html_node/Introduction.html">here</a>). Store the makefile in the same directory as your ASM files and enter <code>make</code> in your terminal to handle all your assembling and linking. Run <code>make clean</code> to get rid of all your object files.</p>
<p>New NASM changes!!!!</p>
<ul>
<li>We can now keep all our syscalls in a convenient external file! The only change here is that we use <code>%include</code> to use them, not <code>.include</code>.</li>
<li>Functions and data exported from other modules with the <code>global</code> keyword must be imported using the <code>extern</code> keyword.</li>
<li>To pad a data item, NASM uses <code>times</code> instead of <code>.rept</code>, and instead of counting word lengths to figure out how much padding you need, there&rsquo;s some useful pointer math you can do using the symbol <code>$</code>, which stands for &ldquo;current memory location&rdquo;. These lines
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-NASM" data-lang="NASM"><span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;Fredrick&#34;</span>
<span style="color:#8be9fd;font-style:italic">times</span> <span style="color:#8be9fd;font-style:italic">record1</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">40</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">$</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#bd93f9">0</span></code></pre></div>
mean &ldquo;store the word Fredrick, then store 0s from the end of that word up to byte 40 of record1&rdquo;.</li>
<li>This chapter uses <code>push</code> with a memory address as its operand. To do this in NASM, the size of the data being pushed has to be defined using one of the <code>type</code> keywords: <code>byte</code>, <code>word</code>, <code>dword</code>, <code>qword</code>, <code>tword</code>, <code>oword</code>, <code>yword</code>, or <code>zword</code>. These follow the pattern of NASM&rsquo;s other size keywords.</li>
<li>These <code>type</code> keywords are used whenever dereferencing data whose size isn&rsquo;t apparent. In the code below, you&rsquo;ll see them when <code>mov</code>-ing a constant into memory, and when <code>inc</code>-rementing a value stored in memory.</li>
<li>Escape characters like newline and <code>NUL</code> only work if your strings are wrapped in backticks (`). You could also use the ASCII values of those characters: 10 for newline, and 0 for <code>NUL</code>.</li>
<li>In the book, read_record and write_record both preserve <code>%rbx</code> since it&rsquo;s used in the syscalls. x64 syscalls don&rsquo;t use <code>%rbx</code> so I didn&rsquo;t bother.</li>
</ul>
<h2 id="exercise-6---writing-structured-data">Exercise 6 - Writing structured data</h2>
<h3 id="linuxasm">linux.asm</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-NASM" data-lang="NASM">    record_firstname<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">0</span>
    record_lastname<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">40</span>
    record_address<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">80</span>
    record_age<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">320</span>
    record_size<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">328</span></code></pre></div>
<h3 id="record-defsasm">record-defs.asm</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-NASM" data-lang="NASM">    <span style="color:#6272a4">;; Common Linux Definitions</span>
    sys_read<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">0</span>
    sys_write<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">1</span>
    sys_open<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">2</span>
    sys_close<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">3</span>
    sys_exit<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">60</span>
    sys_brk<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">12</span>

    <span style="color:#6272a4">;; Standard file descriptors</span>
    stdin<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">0</span>
    stdout<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">1</span>
    stderr<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">2</span>

    <span style="color:#6272a4">;; Common Status Codes</span>
    eof<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">0</span></code></pre></div>
<h3 id="write-recordasm">write-record.asm</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-NASM" data-lang="NASM"><span style="color:#ff79c6">    %include &#34;record-defs.asm&#34;
</span><span style="color:#ff79c6">    %include &#34;linux.asm&#34;
</span><span style="color:#ff79c6"></span>
    st_write_buffer<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">16</span>
    st_filedes<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">24</span>

    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.text</span>
    <span style="color:#ff79c6">global</span> <span style="color:#8be9fd;font-style:italic">write_record</span>
<span style="color:#8be9fd;font-style:italic">write_record:</span>
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rbp</span>, <span style="color:#8be9fd;font-style:italic">rsp</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_write</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_filedes</span>]
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsi</span>, [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_write_buffer</span>]
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdx</span>, <span style="color:#8be9fd;font-style:italic">record_size</span>
    <span style="color:#50fa7b">syscall</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">pop</span> <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">ret</span></code></pre></div>
<h3 id="write-recordsasm">write-records.asm</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-NASM" data-lang="NASM"><span style="color:#ff79c6">    %include &#34;record-defs.asm&#34;
</span><span style="color:#ff79c6">    %include &#34;linux.asm&#34;
</span><span style="color:#ff79c6"></span>
    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.data</span>

<span style="color:#8be9fd;font-style:italic">record1:</span>
    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;Fredrick&#34;</span>
    <span style="color:#8be9fd;font-style:italic">times</span> <span style="color:#8be9fd;font-style:italic">record1</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">40</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">$</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#bd93f9">0</span>

    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;Bartlett&#34;</span>
    <span style="color:#8be9fd;font-style:italic">times</span> <span style="color:#8be9fd;font-style:italic">record1</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">80</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">$</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#bd93f9">0</span>

    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">`4242 S Prairie\nTulsa, OK 55555`</span>
    <span style="color:#8be9fd;font-style:italic">times</span> <span style="color:#8be9fd;font-style:italic">record1</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">320</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">$</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#bd93f9">0</span>

    <span style="color:#8be9fd;font-style:italic">dq</span> <span style="color:#bd93f9">45</span>

<span style="color:#8be9fd;font-style:italic">record2:</span>
    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;Marilyn&#34;</span>
    <span style="color:#8be9fd;font-style:italic">times</span> <span style="color:#8be9fd;font-style:italic">record2</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">40</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">$</span> <span style="color:#8be9fd;font-style:italic">d1</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#bd93f9">0</span>

    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;Taylor&#34;</span>
    <span style="color:#8be9fd;font-style:italic">times</span> <span style="color:#8be9fd;font-style:italic">record2</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">80</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">$</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#bd93f9">0</span>

    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">`2224 S Johannan St\nChicago, IL 12345`</span>
    <span style="color:#8be9fd;font-style:italic">times</span> <span style="color:#8be9fd;font-style:italic">record2</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">320</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">$</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#bd93f9">0</span>

    <span style="color:#8be9fd;font-style:italic">dq</span> <span style="color:#bd93f9">29</span>

<span style="color:#8be9fd;font-style:italic">record3:</span>
    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;Derrick&#34;</span>
    <span style="color:#8be9fd;font-style:italic">times</span> <span style="color:#8be9fd;font-style:italic">record3</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">40</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">$</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#bd93f9">0</span>

    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;McIntire&#34;</span>
    <span style="color:#8be9fd;font-style:italic">times</span> <span style="color:#8be9fd;font-style:italic">record3</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">80</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">$</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#bd93f9">0</span>

    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">`500 W Oakland\nSan Diego, CA 54321`</span>
    <span style="color:#8be9fd;font-style:italic">times</span> <span style="color:#8be9fd;font-style:italic">record3</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">320</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">$</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#bd93f9">0</span>

    <span style="color:#8be9fd;font-style:italic">dq</span> <span style="color:#bd93f9">36</span>

<span style="color:#8be9fd;font-style:italic">filename:</span>
    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;test.dat&#34;</span>, <span style="color:#bd93f9">0</span>

    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.text</span>

    st_file_descriptor<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">8</span>
    <span style="color:#ff79c6">extern</span> <span style="color:#8be9fd;font-style:italic">write_record</span>

    <span style="color:#ff79c6">global</span> <span style="color:#8be9fd;font-style:italic">_start</span>
<span style="color:#8be9fd;font-style:italic">_start:</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rbp</span>, <span style="color:#8be9fd;font-style:italic">rsp</span>
    <span style="color:#50fa7b">sub</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">8</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_open</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, <span style="color:#8be9fd;font-style:italic">filename</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsi</span>, <span style="color:#bd93f9">0</span><span style="color:#8be9fd;font-style:italic">o101</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdx</span>, <span style="color:#bd93f9">0</span><span style="color:#8be9fd;font-style:italic">o666</span>
    <span style="color:#50fa7b">syscall</span>

    <span style="color:#50fa7b">mov</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_file_descriptor</span>], <span style="color:#8be9fd;font-style:italic">rax</span>

    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd">qword</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_file_descriptor</span>]
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">record1</span>
    <span style="color:#50fa7b">call</span> <span style="color:#8be9fd;font-style:italic">write_record</span>
    <span style="color:#50fa7b">add</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">16</span>

    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd">qword</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_file_descriptor</span>]
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">record2</span>
    <span style="color:#50fa7b">call</span> <span style="color:#8be9fd;font-style:italic">write_record</span>
    <span style="color:#50fa7b">add</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">16</span>

    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd">qword</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_file_descriptor</span>]
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">record3</span>
    <span style="color:#50fa7b">call</span> <span style="color:#8be9fd;font-style:italic">write_record</span>
    <span style="color:#50fa7b">add</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">16</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_close</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_file_descriptor</span>]
    <span style="color:#50fa7b">syscall</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_exit</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, <span style="color:#bd93f9">0</span>
    <span style="color:#50fa7b">syscall</span></code></pre></div>
<h2 id="exercise-7---reading-structured-data">Exercise 7 - Reading structured data</h2>
<h3 id="count-charsasm">count-chars.asm</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-NASM" data-lang="NASM">    <span style="color:#ff79c6">global</span> <span style="color:#8be9fd;font-style:italic">count_chars</span>
    st_string_start_address<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">8</span>

<span style="color:#8be9fd;font-style:italic">count_chars:</span>
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rbp</span>, <span style="color:#8be9fd;font-style:italic">rsp</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rcx</span>, <span style="color:#bd93f9">0</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdx</span>, [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_string_start_address</span>]

<span style="color:#8be9fd;font-style:italic">count_loop_begin:</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">al</span>, [<span style="color:#8be9fd;font-style:italic">rdx</span>]
    <span style="color:#50fa7b">cmp</span> <span style="color:#8be9fd;font-style:italic">al</span>, <span style="color:#bd93f9">0</span>
    <span style="color:#50fa7b">je</span> <span style="color:#8be9fd;font-style:italic">count_loop_end</span>
    <span style="color:#50fa7b">inc</span> <span style="color:#8be9fd;font-style:italic">rcx</span>
    <span style="color:#50fa7b">inc</span> <span style="color:#8be9fd;font-style:italic">rdx</span>
    <span style="color:#50fa7b">jmp</span> <span style="color:#8be9fd;font-style:italic">count_loop_begin</span>

<span style="color:#8be9fd;font-style:italic">count_loop_end:</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">rcx</span>
    <span style="color:#50fa7b">pop</span> <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">ret</span></code></pre></div>
<h3 id="write-newlineasm">write-newline.asm</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-NASM" data-lang="NASM"><span style="color:#ff79c6">    %include &#34;linux.asm&#34;
</span><span style="color:#ff79c6"></span>    <span style="color:#ff79c6">global</span> <span style="color:#8be9fd;font-style:italic">write_newline</span>

    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.data</span>
<span style="color:#8be9fd;font-style:italic">newline:</span> <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">`\n`</span> 

    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.text</span>
    st_filedes<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">16</span>
<span style="color:#8be9fd;font-style:italic">write_newline:</span>
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rbp</span>, <span style="color:#8be9fd;font-style:italic">rsp</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_write</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_filedes</span>]
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsi</span>, <span style="color:#8be9fd;font-style:italic">newline</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdx</span>, <span style="color:#bd93f9">2</span>
    <span style="color:#50fa7b">syscall</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">pop</span> <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">ret</span></code></pre></div>
<h3 id="read-recordasm">read-record.asm</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-NASM" data-lang="NASM"><span style="color:#ff79c6">    %include &#34;linux.asm&#34;
</span><span style="color:#ff79c6">        %include &#34;record-defs.asm&#34;
</span><span style="color:#ff79c6"></span>
    st_read_buffer<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">16</span>
    st_filedes<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#bd93f9">24</span>

    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.text</span>
    <span style="color:#ff79c6">global</span> <span style="color:#8be9fd;font-style:italic">read_record</span>
<span style="color:#8be9fd;font-style:italic">read_record:</span>
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rbp</span>, <span style="color:#8be9fd;font-style:italic">rsp</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_read</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_filedes</span>]
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsi</span>, [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_read_buffer</span>]
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdx</span>, <span style="color:#8be9fd;font-style:italic">record_size</span>
    <span style="color:#50fa7b">syscall</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">pop</span> <span style="color:#8be9fd;font-style:italic">rbp</span>
    <span style="color:#50fa7b">ret</span></code></pre></div>
<h3 id="read-recordsasm">read-records.asm</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-NASM" data-lang="NASM"><span style="color:#ff79c6">    %include &#34;linux.asm&#34;
</span><span style="color:#ff79c6">    %include &#34;record-defs.asm&#34;
</span><span style="color:#ff79c6"></span>
    <span style="color:#ff79c6">extern</span> <span style="color:#8be9fd;font-style:italic">count_chars</span>, <span style="color:#8be9fd;font-style:italic">write_newline</span>, <span style="color:#8be9fd;font-style:italic">read_record</span>
    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.data</span>
<span style="color:#8be9fd;font-style:italic">filename:</span>
    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;test.dat&#34;</span>, <span style="color:#bd93f9">0</span>

    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.bss</span>
<span style="color:#8be9fd;font-style:italic">record_buffer:</span>  <span style="color:#8be9fd;font-style:italic">resb</span> <span style="color:#8be9fd;font-style:italic">record_size</span>

    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.text</span>
    <span style="color:#ff79c6">global</span> <span style="color:#8be9fd;font-style:italic">_start</span>
<span style="color:#8be9fd;font-style:italic">_start:</span>
    st_input_descriptor<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">8</span>
    st_output_descriptor<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">16</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rbp</span>, <span style="color:#8be9fd;font-style:italic">rsp</span>
    <span style="color:#50fa7b">sub</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">16</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_open</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, <span style="color:#8be9fd;font-style:italic">filename</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsi</span>, <span style="color:#bd93f9">0</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdx</span>, <span style="color:#bd93f9">0</span><span style="color:#8be9fd;font-style:italic">o666</span>
    <span style="color:#50fa7b">syscall</span>

    <span style="color:#50fa7b">mov</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_input_descriptor</span>], <span style="color:#8be9fd;font-style:italic">rax</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd">qword</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_output_descriptor</span>], <span style="color:#8be9fd;font-style:italic">stdout</span>

<span style="color:#8be9fd;font-style:italic">record_read_loop:</span>
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd">qword</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_input_descriptor</span>]
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">record_buffer</span>
    <span style="color:#50fa7b">call</span> <span style="color:#8be9fd;font-style:italic">read_record</span>
    <span style="color:#50fa7b">add</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">8</span>

    <span style="color:#50fa7b">cmp</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">record_size</span>
    <span style="color:#50fa7b">jne</span> <span style="color:#8be9fd;font-style:italic">finished_reading</span>

    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">record_buffer</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">record_firstname</span>
    <span style="color:#50fa7b">call</span> <span style="color:#8be9fd;font-style:italic">count_chars</span>
    <span style="color:#50fa7b">add</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">8</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdx</span>, <span style="color:#8be9fd;font-style:italic">rax</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_write</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_output_descriptor</span>]
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsi</span>, <span style="color:#8be9fd;font-style:italic">record_buffer</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">record_firstname</span>
    <span style="color:#50fa7b">syscall</span>

    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd">qword</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_output_descriptor</span>]
    <span style="color:#50fa7b">call</span> <span style="color:#8be9fd;font-style:italic">write_newline</span>
    <span style="color:#50fa7b">add</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">8</span>

    <span style="color:#50fa7b">jmp</span> <span style="color:#8be9fd;font-style:italic">record_read_loop</span>

<span style="color:#8be9fd;font-style:italic">finished_reading:</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_exit</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, <span style="color:#bd93f9">0</span>
    <span style="color:#50fa7b">syscall</span></code></pre></div>
<h2 id="exercise-8---modifying-structured-data">Exercise 8 - Modifying structured data</h2>
<h3 id="modify-recordsasm">modify-records.asm</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-NASM" data-lang="NASM"><span style="color:#ff79c6">    %include &#34;linux.asm&#34;
</span><span style="color:#ff79c6">    %include &#34;record-defs.asm&#34;
</span><span style="color:#ff79c6"></span>
    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.data</span>
<span style="color:#8be9fd;font-style:italic">input_file_name:</span>    <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;test.dat&#34;</span>, <span style="color:#bd93f9">0</span>
<span style="color:#8be9fd;font-style:italic">output_file_name:</span>   <span style="color:#8be9fd;font-style:italic">db</span> <span style="color:#f1fa8c">&#34;testout.dat&#34;</span>, <span style="color:#bd93f9">0</span>

    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.bss</span>
<span style="color:#8be9fd;font-style:italic">record_buffer:</span>   <span style="color:#8be9fd;font-style:italic">resb</span> <span style="color:#8be9fd;font-style:italic">record_size</span>

    st_input_descriptor<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">8</span>
    st_output_descriptor<span style="color:#8be9fd;font-style:italic"> equ</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">16</span>

    <span style="color:#ff79c6">section</span> <span style="color:#8be9fd;font-style:italic">.text</span>
    <span style="color:#ff79c6">global</span> <span style="color:#8be9fd;font-style:italic">_start</span>
    <span style="color:#ff79c6">extern</span> <span style="color:#8be9fd;font-style:italic">read_record</span>, <span style="color:#8be9fd;font-style:italic">write_record</span>
<span style="color:#8be9fd;font-style:italic">_start:</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rbp</span>, <span style="color:#8be9fd;font-style:italic">rsp</span>
    <span style="color:#50fa7b">sub</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">16</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_open</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, <span style="color:#8be9fd;font-style:italic">input_file_name</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsi</span>, <span style="color:#bd93f9">0</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdx</span>, <span style="color:#bd93f9">0</span><span style="color:#8be9fd;font-style:italic">o666</span>
    <span style="color:#50fa7b">syscall</span>

    <span style="color:#50fa7b">mov</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_input_descriptor</span>], <span style="color:#8be9fd;font-style:italic">rax</span>

    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_open</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, <span style="color:#8be9fd;font-style:italic">output_file_name</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rsi</span>, <span style="color:#bd93f9">0</span><span style="color:#8be9fd;font-style:italic">o101</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdx</span>, <span style="color:#bd93f9">0</span><span style="color:#8be9fd;font-style:italic">o666</span>
    <span style="color:#50fa7b">syscall</span>

    <span style="color:#50fa7b">mov</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_output_descriptor</span>], <span style="color:#8be9fd;font-style:italic">rax</span>

<span style="color:#8be9fd;font-style:italic">loop_begin:</span>
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd">qword</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_input_descriptor</span>]
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">record_buffer</span>
    <span style="color:#50fa7b">call</span> <span style="color:#8be9fd;font-style:italic">read_record</span>
    <span style="color:#50fa7b">add</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">16</span>

    <span style="color:#50fa7b">cmp</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">record_size</span>
    <span style="color:#50fa7b">jne</span> <span style="color:#8be9fd;font-style:italic">loop_end</span>

    <span style="color:#50fa7b">inc</span> <span style="color:#8be9fd">qword</span> [<span style="color:#8be9fd;font-style:italic">record_buffer</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">record_age</span>]

    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd">qword</span> [<span style="color:#8be9fd;font-style:italic">rbp</span> <span style="color:#ff79c6">+</span> <span style="color:#8be9fd;font-style:italic">st_output_descriptor</span>]
    <span style="color:#50fa7b">push</span> <span style="color:#8be9fd;font-style:italic">record_buffer</span>
    <span style="color:#50fa7b">call</span> <span style="color:#8be9fd;font-style:italic">write_record</span>
    <span style="color:#50fa7b">add</span> <span style="color:#8be9fd;font-style:italic">rsp</span>, <span style="color:#bd93f9">16</span>

    <span style="color:#50fa7b">jmp</span> <span style="color:#8be9fd;font-style:italic">loop_begin</span>

<span style="color:#8be9fd;font-style:italic">loop_end:</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rdi</span>, <span style="color:#8be9fd;font-style:italic">rax</span>
    <span style="color:#50fa7b">mov</span> <span style="color:#8be9fd;font-style:italic">rax</span>, <span style="color:#8be9fd;font-style:italic">sys_exit</span>
    <span style="color:#50fa7b">syscall</span></code></pre></div>
<p class="article-links"><a href="https://brettapitz.github.io/posts/groundup3">Previous Chapter</a>

    <div class="post-tags">
      <span>tags:</span>
      
      <div class="post-tag"><a href="https://brettapitz.github.io/tags/assembly">assembly</a></div>
      
      <div class="post-tag"><a href="https://brettapitz.github.io/tags/comp-sci">comp-sci</a></div>
      
    </div>
    <br>
  </div>
  <div class="below-post"></div>
</div>

            </div><footer id="footer">
  <div id="copyright">Copyright (c) 2021 Brett Apitz</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$("a").click(function(el) {
  let link = $(this).attr("href");
    if (link.match("^mailto")) {

  } else {
    el.preventDefault();

    $("#content").toggleClass("fadePageIn fadePageOut");

    setTimeout(function() {
      window.location = link;
    }, 150);
  }
});
</script>
</footer>
</div>
    </body>
</html>
